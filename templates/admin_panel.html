<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plays'In Yönetim Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7B2CBF;
            --secondary-color: #2D2D2D;
            --background-start: #F5F5F7;
            --background-end: #F8F0FF;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-primary: #2D2D2D;
            --text-secondary: #6B6B6B;
            --border-radius: 16px;
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            color: var(--text-primary);
        }

        .container-fluid {
            max-width: 1600px;
            padding: 2rem;
        }

        .card {
            background: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 24px rgba(123, 44, 191, 0.1);
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(123, 44, 191, 0.15);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #9D4EDD;
            border-color: #9D4EDD;
            color: white;
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .form-control {
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(123, 44, 191, 0.25);
        }

        .device-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .device-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        .active-spotify-device {
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(to right, rgba(123, 44, 191, 0.1), var(--card-bg));
        }

        .filter-list {
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 1rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .filter-list::-webkit-scrollbar {
            width: 8px;
        }

        .filter-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .filter-list::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .filter-list li {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
            transition: var(--transition);
        }

        .filter-list li:hover {
            background: rgba(123, 44, 191, 0.05);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Toggle Switch Stilleri */
        .form-check.form-switch {
            padding-left: 3rem;
        }

        .form-check-input {
            width: 3.5em;
            height: 1.75em;
            margin-left: -3rem;
            background-color: rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border: none;
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(123, 44, 191, 0.25);
        }

        .alert {
            border: none;
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            background: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
            background: rgba(123, 44, 191, 0.1);
        }

        .badge {
            padding: 0.5em 1em;
            border-radius: 8px;
            font-weight: 500;
        }

        .badge.bg-primary {
            background-color: var(--primary-color) !important;
        }

        .badge.bg-success {
            background-color: #4CAF50 !important;
        }

        .currently-playing-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
            font-weight: 600;
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        .queue-item:hover {
            background-color: rgba(123, 44, 191, 0.05);
        }

        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Plays'In Yönetim Paneli</h1>
                <p class="text-muted mb-0">Müzik ve cihaz kontrolü</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                {% if not spotify_authenticated %}
                <a href="{{ url_for('spotify_auth') }}" class="btn btn-primary">
                    <i class="fab fa-spotify me-2"></i>Spotify'ı Bağla
                </a>
                {% endif %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>

        <div id="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
        </div>

        {% if spotify_authenticated %}
        <div class="row g-4">
            <!-- Şu An Çalıyor -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Şu An Çalıyor</h5>
                            <div class="badge bg-success">Aktif</div>
                        </div>
                        {% if currently_playing_info %}
                        <div class="d-flex align-items-center gap-3 mb-3">
                            {% if currently_playing_info.image_url %}
                            <img src="{{ currently_playing_info.image_url }}" alt="Albüm Kapağı" class="currently-playing-img">
                            {% else %}
                            <div class="currently-playing-img d-flex align-items-center justify-content-center bg-light">
                                <i class="fas fa-music fa-2x text-muted"></i>
                            </div>
                            {% endif %}
                            <div class="flex-grow-1 min-width-0">
                                <h6 class="mb-1 text-truncate">{{ currently_playing_info.name }}</h6>
                                <p class="text-muted mb-0 text-truncate">{{ currently_playing_info.artist }}</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% if currently_playing_info.is_playing %}
                            <form action="{{ url_for('player_pause') }}" method="GET" class="flex-grow-1">
                                <button type="submit" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-pause me-2"></i>Durdur
                                </button>
                            </form>
                            {% else %}
                            <form action="{{ url_for('player_resume') }}" method="GET" class="flex-grow-1">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-play me-2"></i>Devam Et
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-music fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Şu anda müzik çalmıyor</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Çalma Kuyruğu -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Çalma Kuyruğu</h5>
                            <div class="d-flex gap-2">
                                <button onclick="playNextTrack()" class="btn btn-sm btn-primary">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                                <div class="badge bg-primary">{{ queue|length if queue else 0 }} Şarkı</div>
                            </div>
                        </div>
                        {% if queue and queue|length > 0 %}
                        <div class="queue-list" style="max-height: 300px; overflow-y: auto;">
                            {% for track in queue %}
                            <div class="queue-item d-flex align-items-center gap-3 p-2 mb-2 rounded hover-bg">
                                {% if track.image_url %}
                                <img src="{{ track.image_url }}" alt="Albüm Kapağı" class="queue-item-img" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">
                                {% else %}
                                <div class="queue-item-img d-flex align-items-center justify-content-center bg-light" style="width: 40px; height: 40px; border-radius: 8px;">
                                    <i class="fas fa-music text-muted"></i>
                                </div>
                                {% endif %}
                                <div class="flex-grow-1 min-width-0">
                                    <h6 class="mb-1 text-truncate">{{ track.name }}</h6>
                                    <p class="text-muted mb-0 text-truncate">{{ track.artist }}</p>
                                </div>
                                <div class="d-flex gap-2">
                                    <button onclick="quickBlockItem(this, 'artist', '{{ track.artist_id }}')" class="btn btn-sm btn-outline-danger" title="Sanatçıyı Engelle">
                                        <i class="fas fa-user-slash"></i>
                                    </button>
                                    <button onclick="quickBlockItem(this, 'song', '{{ track.id }}')" class="btn btn-sm btn-outline-danger" title="Şarkıyı Engelle">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <button onclick="removeFromQueue('{{ track.id }}')" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">Kuyrukta şarkı yok</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Cihaz Yönetimi -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Cihaz Yönetimi</h5>
                            <button onclick="refreshAudioSinkList()" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="audio-sinks-list" class="device-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bluetooth Cihaz Yönetimi -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Bluetooth Cihazları</h5>
                            <div class="d-flex gap-2">
                                <button onclick="refreshBluetoothList(0)" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button id="discover-btn" onclick="discoverBluetoothDevices()" class="btn btn-sm btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Tarama süresi: <span id="scan-duration-text">12</span> saniye</small>
                        </div>
                        <div id="bluetooth-list" class="device-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Spotify Connect Cihazları -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">Spotify Connect Cihazları</h5>
                            <button onclick="refreshSpotifyDevices()" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="spotify-devices-list" class="device-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtre Yönetimi -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Filtre Yönetimi</h5>
                        <form method="POST" action="{{ url_for('update_settings') }}">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">Tür Filtresi</label>
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="genre_mode_switch" 
                                               {% if settings.genre_filter_mode == 'whitelist' %}checked{% endif %}
                                               onchange="updateFilterMode(this, 'genre_filter_mode')">
                                        <label class="form-check-label" for="genre_mode_switch">
                                            <span class="text-muted" id="genre_mode_text">
                                                {% if settings.genre_filter_mode == 'whitelist' %}Beyaz Liste{% else %}Kara Liste{% endif %}
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="filter-list" id="genre-filter-list"></div>
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" id="genre-add-input" placeholder="Yeni tür ekle...">
                                    <button class="btn btn-outline-primary" type="button" onclick="addFilterItem('genre')">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">Sanatçı Filtresi</label>
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input" id="artist_mode_switch"
                                               {% if settings.artist_filter_mode == 'whitelist' %}checked{% endif %}
                                               onchange="updateFilterMode(this, 'artist_filter_mode')">
                                        <label class="form-check-label" for="artist_mode_switch">
                                            <span class="text-muted" id="artist_mode_text">
                                                {% if settings.artist_filter_mode == 'whitelist' %}Beyaz Liste{% else %}Kara Liste{% endif %}
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <div class="filter-list" id="artist-filter-list"></div>
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" id="artist-search-input" placeholder="Sanatçı ara...">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchSpotify('artist')">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="search-results-filter list-group list-group-flush mt-2" id="artist-search-results"></div>
                            </div>

                            <input type="hidden" name="genre_filter_mode" id="genre_filter_mode" value="{{ settings.genre_filter_mode }}">
                            <input type="hidden" name="artist_filter_mode" id="artist_filter_mode" value="{{ settings.artist_filter_mode }}">
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>Ayarları Kaydet
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Global Değişkenler ---
        let currentSettings = JSON.parse('{{ settings | tojson | safe }}');
        let spotifyNameCache = {}; // ID -> Name eşleşmesi için cache

        // --- Yardımcı Fonksiyonlar ---
        function updateFilterMode(switchElement, inputName) {
            const mode = switchElement.checked ? 'whitelist' : 'blacklist';
            const textElement = document.getElementById(inputName.replace('_filter_mode', '_mode_text'));
            const hiddenInput = document.getElementById(inputName);
            
            if (textElement) {
                textElement.textContent = switchElement.checked ? 'Beyaz Liste' : 'Kara Liste';
            }
            if (hiddenInput) {
                hiddenInput.value = mode;
            }

            currentSettings[inputName] = mode;
            const filterType = inputName.replace('_filter_mode', '');
            renderFilterList(filterType);
        }

        function showFlashMessage(message, category = 'info') {
            const flashDiv = document.getElementById('flash-messages');
            if (!flashDiv) return;
            const alertHtml = `<div class="alert alert-${category} alert-dismissible fade show mt-2" role="alert">${message}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>`;
            flashDiv.insertAdjacentHTML('afterbegin', alertHtml);
            window.setTimeout(() => { const el = flashDiv.querySelector('.alert'); if (el) { try { $(el).alert('close'); } catch (e) { el.remove(); } } }, 7000);
        }
        function showListLoading(elementId, message = "Yükleniyor...") { $(`#${elementId}`).html(`<p class="text-muted p-3 text-center"><span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>${message}</p>`); }
        function setButtonLoading(buttonElement, isLoading) {
            if (!buttonElement || typeof buttonElement.classList === 'undefined') { console.error("setButtonLoading called with invalid buttonElement:", buttonElement); return; }
            if (isLoading) {
                buttonElement.disabled = true; buttonElement.classList.add('btn-loading');
                if (!buttonElement.dataset.originalHtml) { buttonElement.dataset.originalHtml = buttonElement.innerHTML; }
                buttonElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> İşleniyor...';
            } else {
                buttonElement.disabled = false; buttonElement.classList.remove('btn-loading');
                if (buttonElement.dataset.originalHtml) { buttonElement.innerHTML = buttonElement.dataset.originalHtml; delete buttonElement.dataset.originalHtml; } // originalHtml'i temizle
                else { buttonElement.textContent = "İşlem"; } // Fallback text
            }
        }

        // --- Listeleri Render Etme Fonksiyonları ---
        function renderAudioSinkList(sinks, defaultSinkName) {
            const listElement = $('#audio-sinks-list'); let html = '';
            if (sinks && sinks.length > 0) {
                 sinks.forEach(sink => {
                     let stateBadge = ''; let stateClass = ''; let isDefault = sink.name === defaultSinkName;
                     if (isDefault) { stateClass = 'default-audio-sink'; stateBadge = '<span class="badge badge-primary ml-1">Varsayılan</span>'; }
                     else if (sink.state === 'RUNNING') { stateClass = 'running-audio-sink'; stateBadge = '<span class="badge badge-success ml-1">Çalışıyor</span>'; }
                     else if (sink.state === 'IDLE') { stateBadge = '<span class="badge badge-secondary ml-1">Boşta</span>'; }
                     else if (sink.state === 'SUSPENDED') { stateBadge = '<span class="badge badge-warning ml-1">Askıda</span>'; }
                     else { stateBadge = `<span class="badge badge-light ml-1">${sink.state || 'Bilinmiyor'}</span>`; }
                     let buttonHtml = !isDefault ? `<button onclick="setDefaultAudioSink(this, '${sink.index}')" class="btn btn-sm btn-outline-primary ml-2" style="white-space: nowrap;">Varsayılan Yap</button>` : '';
                     html += `<div class="device-card mb-2 p-2 border rounded ${stateClass}"><div class="d-flex justify-content-between align-items-center"><div style="min-width: 0;"><strong class="d-block text-truncate" title="${sink.description}">${sink.description}</strong><small class="text-muted d-block text-truncate" title="${sink.name}">(Index: ${sink.index}, Name: ${sink.name}) ${stateBadge}</small></div>${buttonHtml}</div></div>`;
                 });
            } else { html = '<p class="text-muted text-center">Ses çıkış cihazı (sink) bulunamadı.</p>'; }
            listElement.html(html);
         }
        function renderBluetoothList(devices) {
             const listElement = $('#bluetooth-list'); let html = '';
             if (devices && devices.length > 0) {
                 devices.forEach(device => {
                     let cardClass = ''; let actionButtonHtml = ''; let statusBadge = '';
                     const devicePath = device.path || '';
                     if (device.paired) {
                         if (device.connected) {
                             cardClass = 'connected-bluetooth-device'; statusBadge = '<span class="badge badge-primary ml-1">Bağlı</span>';
                             actionButtonHtml = `<button onclick="disconnectDevice(this, '${devicePath}')" data-path="${devicePath}" class="btn btn-sm btn-outline-danger ml-2" style="white-space: nowrap;">Bağlantıyı Kes</button>`;
                         } else {
                             cardClass = ''; statusBadge = '<span class="badge badge-secondary ml-1">Eşleşmiş</span>';
                             actionButtonHtml = `<button onclick="pairDevice(this, '${devicePath}')" data-path="${devicePath}" class="btn btn-sm btn-success ml-2" style="white-space: nowrap;">Bağlan</button>`;
                         }
                     } else {
                         cardClass = 'unpaired-bluetooth-device'; statusBadge = '<span class="badge badge-light ml-1">Yeni</span>';
                         actionButtonHtml = `<button onclick="pairDevice(this, '${devicePath}')" data-path="${devicePath}" class="btn btn-sm btn-warning ml-2" style="white-space: nowrap;">Eşleştir ve Bağlan</button>`;
                     }
                     html += `<div class="device-card mb-2 p-2 border rounded ${cardClass}"><div class="d-flex justify-content-between align-items-center"><div style="min-width: 0;"><strong class="d-block text-truncate" title="${device.name}">${device.name}</strong><small class="text-muted d-block text-truncate">${device.mac_address} ${statusBadge}</small></div>${actionButtonHtml}</div></div>`;
                 });
             } else { html = '<p class="text-muted text-center">Bluetooth cihazı bulunamadı.</p>'; }
             listElement.html(html);
         }

        // --- API Çağrıları ve Liste Yenileme ---
        function refreshAudioSinkList() {
            showListLoading('audio-sinks-list', 'Ses çıkışları yenileniyor...');
            $.get('/api/audio-sinks')
             .done(function(data) { if(data && data.success && data.sinks !== undefined && data.default_sink_name !== undefined) { renderAudioSinkList(data.sinks, data.default_sink_name); } else { $('#audio-sinks-list').html(`<p class="text-danger">Ses listesi alınamadı: ${data.error || '(Veri eksik)'}</p>`); } })
             .fail(function(xhr) { console.error("Error fetching audio sinks:", xhr); $('#audio-sinks-list').html('<p class="text-danger">Ses listesi alınamadı (API Hatası).</p>'); });
        }
        function refreshBluetoothList(duration = 0) {
            const isLoadingKnown = duration === 0; const loadingMessage = isLoadingKnown ? 'Bilinen Bluetooth cihazları listeleniyor...' : 'Yeni Bluetooth cihazları taranıyor...';
            showListLoading('bluetooth-list', loadingMessage); const discoverBtn = document.getElementById('discover-btn');
            if (!isLoadingKnown && discoverBtn) setButtonLoading(discoverBtn, true); // Sadece tarama yaparken butonu kitle
            $.get(`/api/discover-bluetooth?duration=${duration}`)
             .done(function(data) { if(data && data.success && data.devices !== undefined) { renderBluetoothList(data.devices); if (!isLoadingKnown) showFlashMessage('Bluetooth taraması tamamlandı.', 'info'); } else { $('#bluetooth-list').html(`<p class="text-danger">Bluetooth cihazları listelenemedi: ${data.error || '(Veri eksik)'}</p>`); if (!isLoadingKnown) showFlashMessage('Bluetooth taraması sırasında hata oluştu.', 'warning'); } })
             .fail(function(xhr) { console.error("Error fetching/discovering Bluetooth devices:", xhr); $('#bluetooth-list').html('<p class="text-danger">Bluetooth API\'sine ulaşılamadı.</p>'); if (!isLoadingKnown) showFlashMessage('Bluetooth taraması başarısız oldu.', 'danger'); })
             .always(function() { if (!isLoadingKnown && discoverBtn) setButtonLoading(discoverBtn, false); }); // Butonu tekrar aktif et
        }
        function discoverBluetoothDevices() { const el = document.getElementById('scan-duration-text'); const duration = el ? parseInt(el.textContent || '{{ BLUETOOTH_SCAN_DURATION | default(12) }}', 10) : '{{ BLUETOOTH_SCAN_DURATION | default(12) }}'; refreshBluetoothList(duration); }
        function updateRelevantDeviceLists(data) {
             if (data.sinks !== undefined && data.default_sink_name !== undefined) { renderAudioSinkList(data.sinks, data.default_sink_name); } else { refreshAudioSinkList(); }
             if (data.bluetooth_devices !== undefined) { renderBluetoothList(data.bluetooth_devices); } else { refreshBluetoothList(0); }
         }
        function setDefaultAudioSink(buttonElement, sinkIdentifier) {
            console.log("Setting default audio sink to identifier:", sinkIdentifier); let sinkDesc = sinkIdentifier; try { const card = buttonElement.closest('.device-card'); if(card) { const strongElement = card.querySelector('strong'); if (strongElement) sinkDesc = strongElement.textContent || sinkIdentifier; } } catch(e) {}
            if (!confirm(`"${sinkDesc}" adlı ses çıkışını sistemin varsayılanı yapmak istediğinizden emin misiniz?`)) { return; }
            setButtonLoading(buttonElement, true);
            $.ajax({ url: '/api/set-audio-sink', type: 'POST', contentType: 'application/json', data: JSON.stringify({ sink_identifier: sinkIdentifier }),
                success: function(data) { if (data.success) { showFlashMessage(data.message || 'Varsayılan ses çıkışı başarıyla değiştirildi!', 'success'); updateRelevantDeviceLists(data); } else { showFlashMessage('Hata: ' + (data.error || 'Bilinmeyen bir hata oluştu.'), 'danger'); refreshAudioSinkList(); } },
                error: function(xhr) { let errorMsg = 'Bilinmeyen bir sunucu hatası oluştu.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} console.error("Error setting default audio sink:", xhr); showFlashMessage(`Hata: ${errorMsg}`, 'danger'); refreshAudioSinkList(); }
                // complete: function() { // Buton durumu render içinde güncellenir }
            });
        }
        function pairDevice(buttonElement, devicePath) {
            const isPairing = buttonElement.textContent.includes("Eşleştir"); const actionText = isPairing ? "eşleştiriliyor/bağlanılıyor" : "bağlanılıyor"; console.log(`Bluetooth device path ${devicePath} ${actionText}...`);
            if (!devicePath) { showFlashMessage('Hata: Cihaz yolu (path) bulunamadı.', 'danger'); return; }
            setButtonLoading(buttonElement, true);
            $.ajax({ url: '/api/pair-bluetooth', type: 'POST', contentType: 'application/json', data: JSON.stringify({ device_path: devicePath }),
                success: function(data) { if(data.success) { showFlashMessage(data.message || 'Bluetooth cihazı başarıyla bağlandı/eşleştirildi!', 'success'); updateRelevantDeviceLists(data); } else { showFlashMessage('Hata: ' + (data.error || data.message || 'İşlem başarısız.'), 'danger'); refreshBluetoothList(0); refreshAudioSinkList(); } },
                error: function(xhr) { let errorMsg = 'Bilinmeyen bir sunucu hatası oluştu.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); refreshBluetoothList(0); refreshAudioSinkList(); }
                // complete: function() { // Buton durumu render içinde güncellenir }
            });
        }
        function disconnectDevice(buttonElement, devicePath) {
             console.log(`Disconnecting Bluetooth device path ${devicePath}...`); if (!devicePath) { showFlashMessage('Hata: Cihaz yolu (path) bulunamadı.', 'danger'); return; }
             setButtonLoading(buttonElement, true);
             $.ajax({ url: '/api/disconnect-bluetooth', type: 'POST', contentType: 'application/json', data: JSON.stringify({ device_path: devicePath }),
                success: function(data) { if(data.success) { showFlashMessage(data.message || 'Bluetooth bağlantısı kesildi.', 'success'); updateRelevantDeviceLists(data); } else { showFlashMessage('Hata: ' + (data.error || data.message || 'Bağlantı kesilemedi.'), 'danger'); refreshBluetoothList(0); refreshAudioSinkList(); } },
                error: function(xhr) { let errorMsg = 'Bilinmeyen bir sunucu hatası oluştu.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); refreshBluetoothList(0); refreshAudioSinkList(); }
                // complete: function() { // Buton durumu render içinde güncellenir }
            });
        }
        function switchToAlsa(buttonElement) {
            console.log("Switching to ALSA sink..."); if (!confirm('Varsayılan ses çıkışını ALSA uyumlu bir cihaza değiştirmek istediğinizden emin misiniz?')) { return; }
            setButtonLoading(buttonElement, true);
            $.ajax({ url: '/api/switch-to-alsa', type: 'POST', contentType: 'application/json', data: JSON.stringify({}),
                success: function(data) { if (data.success) { showFlashMessage(data.message || 'Başarıyla ALSA ses çıkışına geçildi.', 'success'); updateRelevantDeviceLists(data); } else { showFlashMessage('ALSA Geçiş Hatası: ' + (data.error || 'Bilinmeyen bir hata oluştu.'), 'danger'); refreshAudioSinkList(); } },
                error: function(xhr) { let errorMsg = 'ALSA geçişi sırasında sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} console.error("Error switching to ALSA:", xhr); showFlashMessage(`Hata: ${errorMsg}`, 'danger'); refreshAudioSinkList(); },
                complete: function() { setButtonLoading(buttonElement, false); }
            });
         }
        function restartSpotifyd(buttonElement) {
             console.log("Restarting spotifyd..."); if (!confirm('Spotifyd servisini yeniden başlatmak istediğinizden emin misiniz?')) { return; }
             setButtonLoading(buttonElement, true);
             $.ajax({ url: '/api/restart-spotifyd', type: 'POST', contentType: 'application/json', data: JSON.stringify({}),
                 success: function(data) { if (data.success) { showFlashMessage(data.message || 'Spotifyd başarıyla yeniden başlatıldı.', 'success'); } else { showFlashMessage('Spotifyd Yeniden Başlatma Hatası: ' + (data.error || 'Bilinmeyen hata.'), 'warning'); } },
                 error: function(xhr) { let errorMsg = 'Spotifyd yeniden başlatılırken sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} console.error("Error restarting spotifyd:", xhr); showFlashMessage(`Hata: ${errorMsg}`, 'danger'); },
                 complete: function() { setButtonLoading(buttonElement, false); }
             });
         }

        // --- Filtre Yönetimi Fonksiyonları ---
        function renderFilterList(filterType) {
            const mode = currentSettings[filterType + '_filter_mode']; const listKey = filterType + '_' + mode;
            const list = currentSettings[listKey] || []; const listElement = $(`#${filterType}-filter-list`);
            const modeDisplayElement = $(`#${filterType}-mode-display`); modeDisplayElement.text(mode === 'blacklist' ? 'Kara Liste' : 'Beyaz Liste');
            listElement.html('');
            if (list.length === 0) { listElement.html('<li class="text-muted text-center">Liste boş.</li>'); return; }
            const idsToFetch = [];
            if (filterType === 'artist' || filterType === 'song') { list.forEach(item => { if (!spotifyNameCache[item] && item.startsWith(`spotify:${filterType}:`)) { idsToFetch.push(item); } }); }
            const fetchNamesAndRender = () => {
                let html = '';
                list.forEach(item => {
                    let displayName = item; let displayId = '';
                    if (filterType === 'artist' || filterType === 'song') { displayName = spotifyNameCache[item] || item; if(spotifyNameCache[item]) { displayId = `<span class="item-id">${item}</span>`; } }
                    else { displayName = item; }
                    html += `<li><span><span class="item-name">${displayName}</span>${displayId}</span><button class="btn btn-xs btn-outline-danger" onclick="removeFilterItem('${filterType}', '${mode}', '${item}')"><i class="fas fa-times"></i></button></li>`;
                });
                listElement.html(html);
            };
            if (idsToFetch.length > 0) {
                console.log(`Fetching details for ${filterType} IDs:`, idsToFetch);
                $.ajax({ url: '/api/spotify/details', type: 'POST', contentType: 'application/json', data: JSON.stringify({ ids: idsToFetch, type: filterType }),
                    success: function(data) { if (data.success && data.details) { $.extend(spotifyNameCache, data.details); console.log("Updated spotifyNameCache:", spotifyNameCache); } else { console.warn("Could not fetch some details:", data.error); } },
                    error: function(xhr) { console.error("Error fetching Spotify details:", xhr); },
                    complete: function() { fetchNamesAndRender(); }
                });
            } else { fetchNamesAndRender(); }
        }
        function renderAllFilterLists() { renderFilterList('genre'); renderFilterList('artist'); }
        $('input[name$="_filter_mode"]').on('change', function() {
            const filterType = this.name.replace('_filter_mode', ''); const newMode = this.value;
            console.log(`Filter mode changed for ${filterType} to ${newMode}`);
            currentSettings[filterType + '_filter_mode'] = newMode; renderFilterList(filterType);
            $(`#${filterType}-search-results`).html('');
        });
        function addFilterItem(filterType) {
            const mode = currentSettings[filterType + '_filter_mode']; const listType = mode;
            const inputElement = $(`#${filterType}-add-input`); const item = inputElement.val().trim();
            if (!item) { showFlashMessage('Lütfen eklenecek bir değer girin.', 'warning'); inputElement.focus(); return; }
            console.log(`Adding '${item}' to ${filterType} ${listType} list...`);
            const buttonElement = inputElement.next('.input-group-append').find('button');
            setButtonLoading(buttonElement[0], true);
            $.ajax({ url: '/api/add-to-list', type: 'POST', contentType: 'application/json', data: JSON.stringify({ filter_type: filterType, list_type: listType, item: item }),
                success: function(data) {
                    if (data.success) {
                        showFlashMessage(data.message || 'Öğe listeye eklendi.', 'success');
                        currentSettings[filterType + '_' + listType] = data.updated_list || currentSettings[filterType + '_' + listType];
                        // İsim cache'ini güncellemek için detayları tekrar çekebiliriz veya manuel ekleyebiliriz
                        // Şimdilik sadece listeyi yeniden çizelim
                        renderFilterList(filterType);
                        inputElement.val('');
                    } else { showFlashMessage('Hata: ' + (data.error || 'Ekleme başarısız.'), 'danger'); }
                },
                error: function(xhr) { let errorMsg = 'Listeye eklenirken sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); },
                complete: function() { setButtonLoading(buttonElement[0], false); }
            });
        }
        function removeFilterItem(filterType, listType, item) {
            if (!confirm(`'${spotifyNameCache[item] || item}' öğesini ${filterType} ${listType} listesinden çıkarmak istediğinizden emin misiniz?`)) { return; }
            console.log(`Removing '${item}' from ${filterType} ${listType} list...`);
            $.ajax({ url: '/api/remove-from-list', type: 'POST', contentType: 'application/json', data: JSON.stringify({ filter_type: filterType, list_type: listType, item: item }),
                success: function(data) {
                    if (data.success) {
                        showFlashMessage(data.message || 'Öğe listeden çıkarıldı.', 'success');
                        currentSettings[filterType + '_' + listType] = data.updated_list || currentSettings[filterType + '_' + listType];
                        delete spotifyNameCache[item]; renderFilterList(filterType);
                    } else { showFlashMessage('Hata: ' + (data.error || 'Çıkarma başarısız.'), 'danger'); }
                },
                error: function(xhr) { let errorMsg = 'Listeden çıkarılırken sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); }
            });
        }
        function searchSpotify(searchType) {
            const inputIdPrefix = (searchType === 'track') ? 'song' : searchType;
            const inputElement = $(`#${inputIdPrefix}-search-input`); const query = inputElement.val().trim();
            const resultsContainer = $(`#${inputIdPrefix}-search-results`);
            const buttonElement = inputElement.next('.input-group-append').find('button');
            if (!query) { showFlashMessage('Lütfen arama terimi girin.', 'warning'); inputElement.focus(); return; }
            resultsContainer.html('<p class="text-muted p-2 text-center">Aranıyor...</p>');
            const rawButtonElement = buttonElement.length > 0 ? buttonElement[0] : null;
            setButtonLoading(rawButtonElement, true);
            $.ajax({ url: '/search', type: 'POST', data: `search_query=${encodeURIComponent(query)}&type=${searchType}`,
                success: function(data) {
                    let html = '';
                    if (data.error) { html = `<p class="text-danger p-2 text-center">${data.error}</p>`; }
                    else if (data.results && data.results.length > 0) {
                        data.results.forEach(item => {
                            try {
                                const itemId = item.id; const itemName = item.name || 'İsimsiz'; let itemDetails = '';
                                if (searchType === 'track') { itemDetails = item.artist || 'Bilinmeyen Sanatçı'; }
                                else if (searchType === 'artist') { itemDetails = (Array.isArray(item.genres) && item.genres.length > 0) ? item.genres.join(', ') : 'Tür bilgisi yok'; }
                                const filterItemType = (searchType === 'track') ? 'song' : 'artist';
                                // ID'nin URI formatında olduğundan emin ol (backend zaten yapıyor ama frontend'de de yapalım)
                                const itemUri = itemId.startsWith(`spotify:${filterItemType}:`) ? itemId : `spotify:${filterItemType}:${itemId}`;
                                html += `<a href="#" class="list-group-item list-group-item-action list-group-item-light py-1 px-2" onclick="addFilterItemFromSearch(event, '${filterItemType}', '${itemUri}', '${itemName.replace(/'/g, "\\'")}')"><small><strong>${itemName}</strong><br>${itemDetails || ''}</small></a>`;
                            } catch (renderError) { console.error("Arama sonucu render hatası:", renderError, item); html += `<p class="text-warning p-2 text-center">Bir sonuç işlenirken hata oluştu.</p>`; }
                        });
                    } else { html = '<p class="text-muted p-2 text-center">Sonuç bulunamadı.</p>'; }
                    resultsContainer.html(html);
                },
                error: function(xhr, status, error) { console.error(`Error searching ${searchType}:`, status, error, xhr); let errorMsg = 'Arama sırasında bir sunucu hatası oluştu.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} resultsContainer.html(`<p class="text-danger p-2 text-center">Hata: ${errorMsg}</p>`); },
                complete: function() { setButtonLoading(rawButtonElement, false); }
            });
        }
        function addFilterItemFromSearch(event, filterType, itemUri, itemName) { // itemUri olarak al
            event.preventDefault(); const mode = currentSettings[filterType + '_filter_mode']; const listType = mode;
            if (!confirm(`'${itemName}' öğesini ${filterType} ${listType} listesine eklemek istiyor musunuz?`)) { return; }
            console.log(`Adding '${itemUri}' to ${filterType} ${listType} list from search...`);
            $.ajax({ url: '/api/add-to-list', type: 'POST', contentType: 'application/json', data: JSON.stringify({ filter_type: filterType, list_type: listType, item: itemUri }), // itemUri gönderiliyor
                success: function(data) {
                    if (data.success) {
                        showFlashMessage(data.message || `'${itemName}' listeye eklendi.`, 'success');
                        currentSettings[filterType + '_' + listType] = data.updated_list || currentSettings[filterType + '_' + listType];
                        spotifyNameCache[itemUri] = itemName; // Cache'i güncelle
                        renderFilterList(filterType);
                        $(`#${filterType}-search-results`).html(''); $(`#${filterType}-search-input`).val('');
                    } else { showFlashMessage('Hata: ' + (data.error || 'Ekleme başarısız.'), 'danger'); }
                },
                error: function(xhr) { let errorMsg = 'Listeye eklenirken sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); }
            });
        }
        function searchGenres() {
            const inputElement = $('#genre-search-input'); const query = inputElement.val().trim().toLowerCase();
            const resultsContainer = $('#genre-search-results'); const buttonElement = inputElement.next('.input-group-append').find('button');
            resultsContainer.html('<p class="text-muted p-2 text-center">Türler getiriliyor...</p>');
            setButtonLoading(buttonElement[0], true);
            $.get('/api/spotify/genres')
             .done(function(data) {
                 let html = '';
                 if (data.success && data.genres) {
                     const filteredGenres = data.genres.filter(genre => genre.includes(query));
                     if (filteredGenres.length > 0) {
                         filteredGenres.forEach(genre => { html += `<a href="#" class="list-group-item list-group-item-action list-group-item-light py-1 px-2" onclick="addFilterItemFromSearch(event, 'genre', '${genre}', '${genre}')"><small><strong>${genre}</strong></small></a>`; });
                     } else { html = '<p class="text-muted p-2 text-center">Eşleşen tür bulunamadı.</p>'; }
                 } else { html = `<p class="text-danger p-2 text-center">${data.error || 'Türler alınamadı.'}</p>`; }
                 resultsContainer.html(html);
             })
             .fail(function(xhr) { console.error("Error fetching genres:", xhr); resultsContainer.html('<p class="text-danger p-2 text-center">Türler alınırken hata oluştu.</p>'); })
             .always(function() { setButtonLoading(buttonElement[0], false); });
        }
        function quickBlockItem(buttonElement, itemType, identifier) {
            const typeText = itemType === 'song' ? 'Şarkıyı' : 'Sanatçıyı';
            // ID'nin URI formatında olduğundan emin ol
            const itemUri = identifier.startsWith(`spotify:${itemType}:`) ? identifier : `spotify:${itemType}:${identifier}`;
            if (!confirm(`${typeText} (${spotifyNameCache[itemUri] || itemUri}) kara listeye eklemek istediğinizden emin misiniz?`)) { return; } // İsim göster
            console.log(`Quick blocking ${itemType}: ${itemUri}`);
            setButtonLoading(buttonElement, true);
            $.ajax({ url: '/api/block', type: 'POST', contentType: 'application/json', data: JSON.stringify({ type: itemType, identifier: itemUri }), // itemUri gönderiliyor
                success: function(data) {
                    if (data.success) {
                        showFlashMessage(data.message || 'Öğe başarıyla kara listeye eklendi.', 'success');
                        const listKey = itemType + '_blacklist';
                        if (!currentSettings[listKey]) currentSettings[listKey] = [];
                        if (!currentSettings[listKey].includes(itemUri)) {
                            currentSettings[listKey].push(itemUri); currentSettings[listKey].sort();
                            if (currentSettings[itemType + '_filter_mode'] === 'blacklist') { renderFilterList(itemType); }
                        }
                    } else { showFlashMessage('Hata: ' + (data.error || 'Engelleme başarısız.'), 'danger'); }
                },
                error: function(xhr) { let errorMsg = 'Engelleme sırasında sunucu hatası.'; try { if(xhr.responseJSON && xhr.responseJSON.error){ errorMsg = xhr.responseJSON.error; } } catch(e){} showFlashMessage(`Hata: ${errorMsg}`, 'danger'); },
                complete: function() { setButtonLoading(buttonElement, false); }
            });
        }

        // --- Sayfa Yüklendiğinde Çalışacak Kod ---
        $(document).ready(function() {
            refreshAudioSinkList(); refreshBluetoothList(0);
            const initialArtistIds = [...(currentSettings.artist_blacklist || []), ...(currentSettings.artist_whitelist || [])];
            const initialSongIds = [...(currentSettings.song_blacklist || []), ...(currentSettings.song_whitelist || [])];
            const allIdsToFetch = { artist: [...new Set(initialArtistIds)], track: [...new Set(initialSongIds)] };
            const fetchPromises = [];
            for (const type in allIdsToFetch) {
                const ids = allIdsToFetch[type];
                if (ids.length > 0) {
                    console.log(`Pre-fetching details for ${type} IDs:`, ids);
                    fetchPromises.push( $.ajax({ url: '/api/spotify/details', type: 'POST', contentType: 'application/json', data: JSON.stringify({ ids: ids, type: type }) }).done(function(data) { if (data.success && data.details) { $.extend(spotifyNameCache, data.details); } }).fail(function(xhr) { console.error(`Error pre-fetching ${type} details:`, xhr); }) );
                }
            }
            $.when.apply($, fetchPromises).always(function() { console.log("Initial name cache loaded:", spotifyNameCache); renderAllFilterLists(); });
            const scanDurationTextElement = document.getElementById('scan-duration-text');
            if (scanDurationTextElement) { scanDurationTextElement.textContent = '{{ BLUETOOTH_SCAN_DURATION | default(12) }}'; }
        });

        function removeFromQueue(trackId) {
            fetch(`/remove-from-queue/${trackId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Şarkıyı listeden kaldır
                    const trackElement = document.querySelector(`[data-track-id="${trackId}"]`);
                    if (trackElement) {
                        trackElement.remove();
                    }
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Şarkı kaldırılırken hata:', error);
                showNotification('Şarkı kaldırılırken bir hata oluştu', 'error');
            });
        }

        function refreshSpotifyDevices() {
            showListLoading('spotify-devices-list', 'Spotify cihazları yenileniyor...');
            $.get('/api/spotify-devices')
                .done(function(data) {
                    if (data.success && data.devices) {
                        renderSpotifyDevicesList(data.devices, data.active_device_id);
                    } else {
                        $('#spotify-devices-list').html(`<p class="text-danger">Cihaz listesi alınamadı: ${data.error || '(Veri eksik)'}</p>`);
                    }
                })
                .fail(function(xhr) {
                    console.error("Error fetching Spotify devices:", xhr);
                    $('#spotify-devices-list').html('<p class="text-danger">Cihaz listesi alınamadı (API Hatası).</p>');
                });
        }

        function renderSpotifyDevicesList(devices, activeDeviceId) {
            const listElement = $('#spotify-devices-list');
            let html = '';
            
            if (devices && devices.length > 0) {
                devices.forEach(device => {
                    const isActive = device.id === activeDeviceId;
                    const stateClass = isActive ? 'active-spotify-device' : '';
                    const stateBadge = isActive ? '<span class="badge bg-primary ml-1">Aktif</span>' : '';
                    
                    html += `
                        <div class="device-card mb-2 p-2 border rounded ${stateClass}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="min-width: 0;">
                                    <strong class="d-block text-truncate" title="${device.name}">${device.name}</strong>
                                    <small class="text-muted d-block text-truncate">${device.type} ${stateBadge}</small>
                                </div>
                                ${!isActive ? `<button onclick="transferPlayback(this, '${device.id}')" class="btn btn-sm btn-outline-primary ml-2">Bu Cihaza Aktar</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p class="text-muted text-center">Spotify Connect cihazı bulunamadı.</p>';
            }
            
            listElement.html(html);
        }

        function transferPlayback(buttonElement, deviceId) {
            if (!confirm('Çalma işlemini bu cihaza aktarmak istediğinizden emin misiniz?')) {
                return;
            }
            
            setButtonLoading(buttonElement, true);
            
            $.ajax({
                url: '/api/transfer-playback',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ device_id: deviceId }),
                success: function(data) {
                    if (data.success) {
                        showFlashMessage('Çalma işlemi başarıyla aktarıldı.', 'success');
                        refreshSpotifyDevices();
                    } else {
                        showFlashMessage('Hata: ' + (data.error || 'Aktarım başarısız.'), 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Çalma işlemi aktarılırken sunucu hatası.';
                    try {
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                    } catch (e) {}
                    showFlashMessage(`Hata: ${errorMsg}`, 'danger');
                },
                complete: function() {
                    setButtonLoading(buttonElement, false);
                }
            });
        }

        function playNextTrack() {
            const button = document.querySelector('button[onclick="playNextTrack()"]');
            setButtonLoading(button, true);
            
            $.ajax({
                url: '/api/play-next',
                type: 'POST',
                contentType: 'application/json',
                success: function(data) {
                    if (data.success) {
                        showFlashMessage('Sıradaki şarkı çalmaya başladı.', 'success');
                        // Kuyruğu yenile
                        refreshQueue();
                    } else {
                        showFlashMessage('Hata: ' + (data.error || 'Şarkı çalınamadı.'), 'danger');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Şarkı çalınırken sunucu hatası.';
                    try {
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                    } catch (e) {}
                    showFlashMessage(`Hata: ${errorMsg}`, 'danger');
                },
                complete: function() {
                    setButtonLoading(button, false);
                }
            });
        }

        function refreshQueue() {
            $.get('/api/queue')
                .done(function(data) {
                    if (data.success && data.queue) {
                        // Kuyruk listesini güncelle
                        const queueList = $('.queue-list');
                        let html = '';
                        
                        if (data.queue.length > 0) {
                            data.queue.forEach(track => {
                                html += `
                                    <div class="queue-item d-flex align-items-center gap-3 p-2 mb-2 rounded hover-bg">
                                        ${track.image_url ? 
                                            `<img src="${track.image_url}" alt="Albüm Kapağı" class="queue-item-img" style="width: 40px; height: 40px; object-fit: cover; border-radius: 8px;">` :
                                            `<div class="queue-item-img d-flex align-items-center justify-content-center bg-light" style="width: 40px; height: 40px; border-radius: 8px;">
                                                <i class="fas fa-music text-muted"></i>
                                            </div>`
                                        }
                                        <div class="flex-grow-1 min-width-0">
                                            <h6 class="mb-1 text-truncate">${track.name}</h6>
                                            <p class="text-muted mb-0 text-truncate">${track.artist}</p>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button onclick="quickBlockItem(this, 'artist', '${track.artist_id}')" class="btn btn-sm btn-outline-danger" title="Sanatçıyı Engelle">
                                                <i class="fas fa-user-slash"></i>
                                            </button>
                                            <button onclick="quickBlockItem(this, 'song', '${track.id}')" class="btn btn-sm btn-outline-danger" title="Şarkıyı Engelle">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            <button onclick="removeFromQueue('${track.id}')" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            html = `
                                <div class="text-center py-4">
                                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">Kuyrukta şarkı yok</p>
                                </div>
                            `;
                        }
                        
                        queueList.html(html);
                        // Şarkı sayısını güncelle
                        $('.badge.bg-primary').text(`${data.queue.length} Şarkı`);
                    }
                })
                .fail(function(xhr) {
                    console.error("Error fetching queue:", xhr);
                    showFlashMessage('Kuyruk yenilenirken hata oluştu.', 'danger');
                });
        }
    </script>

</body>
</html>
