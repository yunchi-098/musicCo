<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mekan Müzik Yönetim Paneli - Birleştirilmiş</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card-header {
            font-weight: 600;
        }
        .list-group-item {
            border-color: rgba(0,0,0,.075);
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            display: flex; /* Flexbox for alignment */
            justify-content: space-between;
            align-items: center;
        }
        .list-group-item:last-child {
            border-bottom-width: 1px;
        }
        .list-group-item .device-info,
        .list-group-item .sink-info {
             flex-grow: 1;
             margin-right: 10px;
             min-width: 0; /* Prevent overflow */
        }
        .list-group-item .action-buttons {
             flex-shrink: 0;
             white-space: nowrap;
        }
        .device-icon {
            width: 20px;
            text-align: center;
            margin-right: 8px;
            color: #6c757d;
        }
        .device-icon.audio-card { color: #007bff; }
        .device-icon.phone { color: #28a745; }
        .device-icon.computer { color: #17a2b8; }
        .device-icon.default { color: #6c757d; }

        .signal-strength {
            font-size: 0.8em;
            color: #6c757d;
        }
        .signal-strength.strong { color: #28a745; }
        .signal-strength.medium { color: #ffc107; }
        .signal-strength.weak { color: #dc3545; }

        .action-buttons .btn {
            margin-left: 5px;
        }
        .action-buttons .btn-sm {
             padding: 0.2rem 0.4rem;
             font-size: 0.8rem;
        }
        .btn .spinner-border {
            width: 1em;
            height: 1em;
            border-width: .15em;
            vertical-align: -0.125em;
            margin-right: 0.3em;
        }
        .card-body-scrollable {
            max-height: 300px; /* Adjusted height */
            overflow-y: auto;
        }
        .alert { margin-top: 15px; }
        .status-indicator {
             display: inline-block;
             width: 10px;
             height: 10px;
             border-radius: 50%;
             margin-right: 5px;
             vertical-align: middle;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-paired { background-color: #007bff; }
        .status-unpaired { background-color: #6c757d; }
        .status-default { background-color: #ffc107; }

        .device-name, .sink-description {
             font-weight: 500;
             display: block;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
        }
         .device-details, .sink-name {
             font-size: 0.85em;
             color: #6c757d;
             display: block;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }
         /* Spotify Currently Playing */
         .currently-playing-img {
             width: 50px; /* Adjusted size */
             height: 50px;
             object-fit: cover;
             border: 1px solid #dee2e6;
             border-radius: .25rem;
             flex-shrink: 0; /* Prevent shrinking */
         }
         .currently-playing-placeholder {
             width: 50px;
             height: 50px;
             background-color: #e9ecef;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: .25rem;
             color: #6c757d;
             font-size: 1.2rem;
             font-weight: bold;
             flex-shrink: 0;
         }
         /* Active Spotify Connect Device Highlight */
         .active-spotify-device {
             border-left: 4px solid #1DB954 !important; /* Spotify green */
             background-color: #e6f7f0 !important;
         }
         .active-spotify-device strong, .active-spotify-device small {
              color: #0d6a39 !important;
         }
         /* Ensure cards have consistent height in a row */
         .row {
             display: flex;
             flex-wrap: wrap;
         }
         .row > [class*='col-'] {
             display: flex;
             flex-direction: column;
             margin-bottom: 1.5rem; /* Add space between rows of cards */
         }
         .row > [class*='col-'] > .card {
            flex: 1 1 auto; /* Make card fill the column height */
         }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
            <h1 class="h2 text-primary font-weight-bold">Mekan Müzik Yönetim Paneli</h1>
            <div>
                <button id="refresh-all-btn" class="btn btn-sm btn-secondary mr-2" title="Tüm Verileri Yenile">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt"></i> Çıkış Yap
                </a>
            </div>
        </div>

        <div id="flash-messages">
             {% with messages = get_flashed_messages(with_categories=true) %}
               {% if messages %}
                 {% for category, message in messages %}
                   <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                     {{ message }}
                     <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                       <span aria-hidden="true">×</span>
                     </button>
                   </div>
                 {% endfor %}
               {% endif %}
             {% endwith %}
        </div>
        <div id="status-message-area" style="min-height: 50px;"></div>

        {% if spotify_authenticated is defined %} {# Check if variable exists #}
            {% if not spotify_authenticated %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                Spotify bağlantısı yok! Lütfen Spotify hesabınızı bağlayın.
                <a href="{{ url_for('spotify_auth') }}" class="btn btn-sm btn-primary ml-2">Şimdi Yetkilendir</a>
                 <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                   <span aria-hidden="true">×</span>
                 </button>
            </div>
            {% else %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                Spotify bağlı: <strong>{{ spotify_user or 'Bilinmeyen Kullanıcı' }}</strong>
                 <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                   <span aria-hidden="true">×</span>
                 </button>
            </div>
            {% endif %}
        {% else %}
             <div class="alert alert-secondary" role="alert">
                 Spotify durumu yükleniyor... (Backend bağlantısı gerekli)
             </div>
        {% endif %}


        <div class="row">

            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fab fa-spotify"></i> Şu An Çalıyor</h5>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-between">
                        {% if currently_playing_info %}
                            <div class="d-flex align-items-center mb-3">
                                {% if currently_playing_info.image_url %}
                                <img src="{{ currently_playing_info.image_url }}" alt="Albüm Kapağı"
                                     class="mr-3 shadow-sm currently-playing-img">
                                {% else %}
                                <div class="mr-3 currently-playing-placeholder">?</div>
                                {% endif %}
                                <div style="min-width: 0;">
                                    <strong class="d-block text-truncate">{{ currently_playing_info.name }}</strong>
                                    <small class="text-muted d-block text-truncate">{{ currently_playing_info.artist }}</small>
                                </div>
                            </div>
                            <div class="mt-auto"> {# Buttons at the bottom #}
                                {% if currently_playing_info.is_playing %}
                                    <form action="{{ url_for('player_pause') }}" method="GET" class="d-inline">
                                         <button type="submit" class="btn btn-warning btn-sm btn-block">
                                             <i class="fas fa-pause"></i> Durdur
                                         </button>
                                     </form>
                                {% else %}
                                    <form action="{{ url_for('player_resume') }}" method="GET" class="d-inline">
                                         <button type="submit" class="btn btn-success btn-sm btn-block">
                                             <i class="fas fa-play"></i> Devam Et
                                         </button>
                                     </form>
                                {% endif %}
                                {# Add Next/Previous if needed and supported by backend #}
                                {# <form action="{{ url_for('player_next') }}" method="GET" class="d-inline">
                                     <button type="submit" class="btn btn-info btn-sm"><i class="fas fa-forward"></i></button>
                                </form> #}
                            </div>
                        {% else %}
                            <p class="text-muted text-center my-auto">Şu anda aktif bir şarkı çalınmıyor veya bilgi alınamadı.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-podcast"></i> Spotify Connect</h5>
                         <form action="{{ url_for('refresh_devices') }}" method="GET" class="d-inline">
                              <button type="submit" class="btn btn-sm btn-light" title="Connect Cihazlarını Yenile">
                                  <i class="fas fa-sync-alt"></i>
                              </button>
                         </form>
                    </div>
                    <div class="card-body card-body-scrollable">
                        {% if spotify_devices %}
                            <div class="list-group list-group-flush">
                                {% for device in spotify_devices %}
                                <div class="list-group-item px-0 py-2 {% if device.id == active_spotify_connect_device_id %}active-spotify-device{% endif %}">
                                    <div class="device-info">
                                        <strong class="d-block text-truncate device-name">{{ device.name }}</strong>
                                        <small class="text-muted device-details">{{ device.type|upper }} {% if device.is_restricted %}(Kısıtlı){% endif %} {% if device.volume_percent is not none %}- Ses: {{device.volume_percent}}%{% endif %}</small>
                                    </div>
                                    {# Aktif Spotify Connect cihazını seçme formu (Original Form Method) #}
                                    <form method="POST" action="{{ url_for('update_settings') }}" class="action-buttons">
                                        <input type="hidden" name="active_spotify_connect_device_id" value="{{ device.id }}">
                                        <button type="submit" class="btn btn-sm {% if device.id == active_spotify_connect_device_id %}btn-success disabled{% else %}btn-outline-primary{% endif %}"
                                                {% if device.id == active_spotify_connect_device_id %}aria-disabled="true"{% endif %}>
                                            {% if device.id == active_spotify_connect_device_id %}Aktif{% else %}Seç{% endif %}
                                        </button>
                                    </form>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted text-center">Aktif Spotify Connect cihazı bulunamadı. <a href="{{ url_for('refresh_devices') }}">Yenilemeyi deneyin</a>.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-list-ol"></i> Şarkı Kuyruğu ({{ queue|length if queue is defined else 0 }}/{{ settings.max_queue_length if settings is defined else '?' }})</h5>
                    </div>
                    <div class="card-body card-body-scrollable">
                        {% if queue %}
                        <ul class="list-group list-group-flush">
                            {% for song in queue %}
                            <li class="list-group-item px-0 py-2">
                                <div class="device-info"> {# Reusing class for structure #}
                                    <strong class="d-block text-truncate device-name">{{ song.name }}</strong>
                                    <small class="text-muted d-block text-truncate device-details">{{ song.artist }}</small>
                                </div>
                                <form method="POST" action="{{ url_for('remove_song', song_id=song.id) }}" class="action-buttons">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Kuyruktan Kaldır">×</button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted text-center">Kuyruk boş.</p>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <form method="POST" action="{{ url_for('add_song') }}" class="input-group mb-2">
                            <input type="text" name="song_id" class="form-control form-control-sm"
                                   placeholder="Spotify Şarkı ID veya URL" required>
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-sm btn-success">Ekle</button>
                            </div>
                        </form>
                        <form method="POST" action="{{ url_for('clear_queue') }}" onsubmit="return confirm('Tüm şarkı kuyruğunu temizlemek istediğinizden emin misiniz?');">
                             <button type="submit" class="btn btn-sm btn-danger btn-block">
                                 Kuyruğu Temizle
                             </button>
                         </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fab fa-bluetooth-b"></i> Bluetooth Yönetimi</h5>
                        <button id="scan-bluetooth-btn" class="btn btn-sm btn-light">
                            <i class="fas fa-search"></i> Tara
                        </button>
                    </div>
                    <div class="card-body">
                        <h6><i class="fas fa-link"></i> Eşleşmiş Cihazlar</h6>
                        <div id="paired-devices-list" class="list-group list-group-flush mb-3 card-body-scrollable" style="max-height: 200px;">
                            <div class="list-group-item text-muted text-center no-paired-placeholder">Yükleniyor...</div>
                        </div>

                        <h6><i class="fas fa-broadcast-tower"></i> Keşfedilen Cihazlar</h6>
                        <div id="discovered-devices-list" class="list-group list-group-flush card-body-scrollable" style="max-height: 200px;">
                            <div class="list-group-item text-muted text-center no-discovered-placeholder">Tarama bekleniyor...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-volume-up"></i> Ses Çıkış Yönetimi</h5>
                        <button id="refresh-sinks-btn" class="btn btn-sm btn-light" title="Ses Çıkışlarını Yenile">
                             <i class="fas fa-sync-alt"></i>
                         </button>
                    </div>
                    <div class="card-body card-body-scrollable">
                        <div id="audio-sinks-list" class="list-group list-group-flush">
                             <div class="list-group-item text-muted text-center no-sinks-placeholder">Yükleniyor...</div>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                         <button id="switch-alsa-btn" class="btn btn-warning btn-block">
                             <i class="fas fa-headphones-alt"></i> Varsayılan Ses Çıkışına (ALSA) Geç
                         </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12">
                 <div class="card shadow-sm h-100">
                     <div class="card-header bg-light"> {# Changed color #}
                         <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Genel Ayarlar</h5>
                     </div>
                     <div class="card-body">
                         {# Check if settings variable exists from backend #}
                         {% if settings is defined and all_genres is defined %}
                         <form method="POST" action="{{ url_for('update_settings') }}">
                             <div class="form-row">
                                 <div class="form-group col-md-6">
                                     <label for="max_queue_length">Maks. Kuyruk Uzunluğu</label>
                                     <input type="number" id="max_queue_length" name="max_queue_length"
                                            value="{{ settings.max_queue_length }}"
                                            class="form-control form-control-sm" min="1" required>
                                 </div>
                                 <div class="form-group col-md-6">
                                     <label for="max_user_requests">Kullanıcı Başına Maks. İstek</label>
                                     <input type="number" id="max_user_requests" name="max_user_requests"
                                            value="{{ settings.max_user_requests }}"
                                            class="form-control form-control-sm" min="1" required>
                                 </div>
                             </div>
                             <div class="form-group">
                                 <label>Aktif Müzik Türleri</label>
                                 <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ced4da; padding: 10px; border-radius: .25rem;">
                                     <div class="row">
                                         {% for genre in all_genres %}
                                         <div class="col-6 col-sm-4"> {# Adjusted columns for better fit #}
                                             <div class="form-check">
                                                 <input class="form-check-input" type="checkbox"
                                                        name="genre_{{ genre }}" value="1" {# Send value=1 if checked #}
                                                        id="genre_{{ genre }}"
                                                        {% if genre in settings.active_genres %}checked{% endif %}>
                                                 <label class="form-check-label" for="genre_{{ genre }}">
                                                     {{ genre|title }}
                                                 </label>
                                             </div>
                                         </div>
                                         {% endfor %}
                                     </div>
                                 </div>
                             </div>
                             <button type="submit" class="btn btn-primary btn-block mt-3">
                                 Ayarları Kaydet
                             </button>
                         </form>
                         {% else %}
                          <p class="text-muted text-center">Ayarlar yüklenemedi (Backend bağlantısı gerekli).</p>
                         {% endif %}
                     </div>
                 </div>
             </div>

             <div class="col-lg-6 col-md-12">
                 <div class="card shadow-sm h-100">
                     <div class="card-header bg-secondary text-white">
                         <h5 class="mb-0"><i class="fas fa-cogs"></i> Diğer & Durum</h5>
                     </div>
                     <div class="card-body">
                         <div class="text-center mb-4">
                             <button id="restart-spotifyd-btn" class="btn btn-danger">
                                 <i class="fab fa-spotify"></i> Spotify Servisini Yeniden Başlat
                             </button>
                             <p class="text-muted mt-1"><small>Spotify sorunları için.</small></p>
                         </div>
                         <h6><i class="fas fa-info-circle"></i> Sistem Durumu</h6>
                         <ul class="list-group list-group-flush">
                              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                  Bluetooth Servisi:
                                  <span id="status-bluetooth-service" class="badge badge-secondary">Yükleniyor...</span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                  PulseAudio Servisi:
                                  <span id="status-pulseaudio-service" class="badge badge-secondary">Yükleniyor...</span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                  Varsayılan Ses Çıkışı:
                                  <span id="status-default-sink" class="badge badge-secondary">Yükleniyor...</span>
                              </li>
                          </ul>
                     </div>
                 </div>
             </div>

        </div> </div> <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // --- Global Değişkenler ---
        let currentBluetoothDevices = [];
        let currentAudioSinks = [];
        let defaultSinkName = null;

        // --- Yardımcı Fonksiyonlar ---
        async function handleApiCall(endpoint, method = 'GET', data = null, buttonElement = null) {
            const url = `/api${endpoint}`;
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            };
            if (data && method !== 'GET') options.body = JSON.stringify(data);

            let originalButtonHTML = '';
            if (buttonElement) {
                originalButtonHTML = buttonElement.innerHTML;
                setButtonLoading(buttonElement, true);
            }

            try {
                const response = await fetch(url, options);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData?.message || `HTTP Error: ${response.status}`);
                if (responseData.message && method !== 'GET') { // Show messages only for actions (POST, etc.)
                    showStatusMessage(responseData.message, responseData.success !== false ? 'success' : 'warning');
                }
                return responseData;
            } catch (error) {
                console.error(`API Call Error (${method} ${url}):`, error);
                showStatusMessage(`Hata: ${error.message || 'Bilinmeyen hata.'}`, 'danger');
                return { success: false, error: error.message };
            } finally {
                if (buttonElement) setButtonLoading(buttonElement, false, originalButtonHTML);
            }
        }

        function showStatusMessage(message, type = 'info', duration = 5000) {
            const statusArea = document.getElementById('status-message-area');
            if (!statusArea) return;
            const alertId = `alert-${Date.now()}`;
            const alertHtml = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mt-2" role="alert">${message}<button type="button" class="close" data-dismiss="alert">&times;</button></div>`;
            statusArea.insertAdjacentHTML('afterbegin', alertHtml);
            if (duration > 0) setTimeout(() => $(`#${alertId}`).alert('close'), duration);
        }

        function setButtonLoading(buttonElement, isLoading, originalHTML = null) {
            if (!buttonElement) return;
            if (isLoading) {
                buttonElement.disabled = true;
                if (!buttonElement.dataset.originalHTML) buttonElement.dataset.originalHTML = buttonElement.innerHTML;
                buttonElement.innerHTML = `<span class="spinner-border spinner-border-sm" role="status"></span> Yükleniyor...`;
            } else {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalHTML || buttonElement.dataset.originalHTML || 'Eylem';
                delete buttonElement.dataset.originalHTML;
            }
        }

        function getDeviceIconClass(iconName) { /* ... (same as before) ... */
             iconName = iconName ? iconName.toLowerCase() : 'default';
             if (iconName.startsWith('audio-')) return 'audio-card';
             if (iconName === 'phone') return 'phone';
             if (iconName === 'computer') return 'computer';
             return 'default';
         }
        function getSignalStrengthClass(rssi) { /* ... (same as before) ... */
            if (rssi == null || rssi <= -100) return ''; // Handle null or invalid RSSI
            if (rssi >= -67) return 'strong';
            if (rssi >= -75) return 'medium';
            return 'weak';
        }

        // --- Rendering Functions ---
        function renderBluetoothLists() {
            const pairedList = document.getElementById('paired-devices-list');
            const discoveredList = document.getElementById('discovered-devices-list');
            pairedList.innerHTML = '';
            discoveredList.innerHTML = '';
            let hasPaired = false, hasDiscovered = false;

            const pairedDevices = currentBluetoothDevices.filter(d => d.paired);
            const discoveredDevices = currentBluetoothDevices.filter(d => !d.paired);

            pairedDevices.forEach(device => {
                hasPaired = true;
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item';
                listItem.dataset.address = device.address;
                const iconClass = getDeviceIconClass(device.icon);
                const signalClass = getSignalStrengthClass(device.rssi);
                const signalText = (device.rssi != null && device.rssi > -100) ? `${device.rssi} dBm` : 'N/A';

                listItem.innerHTML = `
                    <div class="device-info">
                        <span class="device-name">
                            <i class="fas fa-${iconClass === 'default' ? 'bluetooth-b' : (iconClass === 'audio-card' ? 'headphones' : iconClass)} device-icon ${iconClass}"></i>
                            ${device.name || 'İsimsiz Cihaz'}
                        </span>
                        <span class="device-details">
                            ${device.address} -
                            <span class="status-indicator ${device.connected ? 'status-connected' : 'status-disconnected'}" title="${device.connected ? 'Bağlı' : 'Bağlı Değil'}"></span> ${device.connected ? 'Bağlı' : 'Bağlı Değil'} -
                            <span class="signal-strength ${signalClass}" title="Sinyal Gücü">${signalText}</span>
                            ${device.audio_device ? '<i class="fas fa-music ml-1" title="Ses Cihazı"></i>' : ''}
                            ${device.trusted ? '<i class="fas fa-user-check ml-1" title="Güvenilir"></i>' : ''}
                        </span>
                    </div>
                    <div class="action-buttons">
                        ${device.connected
                            ? `<button class="btn btn-sm btn-warning disconnect-btn" title="Bağlantıyı Kes"><i class="fas fa-unlink"></i></button>`
                            : `<button class="btn btn-sm btn-success connect-btn" title="Bağlan"><i class="fas fa-plug"></i></button>`
                        }
                        <button class="btn btn-sm btn-danger remove-btn" title="Cihazı Kaldır"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                pairedList.appendChild(listItem);
            });

            discoveredDevices.forEach(device => {
                hasDiscovered = true;
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item';
                listItem.dataset.address = device.address;
                const iconClass = getDeviceIconClass(device.icon);
                const signalClass = getSignalStrengthClass(device.rssi);
                const signalText = (device.rssi != null && device.rssi > -100) ? `${device.rssi} dBm` : 'N/A';

                listItem.innerHTML = `
                    <div class="device-info">
                        <span class="device-name">
                            <i class="fas fa-${iconClass === 'default' ? 'bluetooth-b' : (iconClass === 'audio-card' ? 'headphones' : iconClass)} device-icon ${iconClass}"></i>
                             ${device.name || 'İsimsiz Cihaz'}
                        </span>
                         <span class="device-details">
                            ${device.address} -
                            <span class="signal-strength ${signalClass}" title="Sinyal Gücü">${signalText}</span>
                            ${device.audio_device ? '<i class="fas fa-music ml-1" title="Ses Cihazı"></i>' : ''}
                        </span>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary pair-btn" title="Eşleştir"><i class="fas fa-link"></i></button>
                    </div>`;
                discoveredList.appendChild(listItem);
            });

            if (!hasPaired) pairedList.innerHTML = '<div class="list-group-item text-muted text-center no-paired-placeholder">Eşleşmiş cihaz yok.</div>';
            if (!hasDiscovered) discoveredList.innerHTML = '<div class="list-group-item text-muted text-center no-discovered-placeholder">Keşfedilen cihaz yok.</div>';

            attachBluetoothButtonListeners();
        }

        function renderSinkList() {
            const sinkList = document.getElementById('audio-sinks-list');
            sinkList.innerHTML = '';
            if (currentAudioSinks && currentAudioSinks.length > 0) {
                currentAudioSinks.forEach(sink => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item'; // Removed flex here, handled inside
                    listItem.dataset.sinkIndex = sink.index;
                    listItem.dataset.sinkName = sink.name;
                    const isDefault = sink.name === defaultSinkName;
                    listItem.innerHTML = `
                        <div class="sink-info">
                             <span class="status-indicator ${isDefault ? 'status-default' : ''}" title="${isDefault ? 'Varsayılan Cihaz' : ''}"></span>
                             <strong class="sink-description">${sink.description}</strong>
                             <small class="text-muted d-block sink-name">${sink.name}</small>
                         </div>
                         <div class="action-buttons">
                             <button class="btn btn-sm ${isDefault ? 'btn-secondary disabled' : 'btn-outline-success'} switch-sink-btn" ${isDefault ? 'disabled' : ''}>
                                 ${isDefault ? 'Aktif' : 'Seç'}
                             </button>
                         </div>`;
                    sinkList.appendChild(listItem);
                });
                 attachSinkButtonListeners();
            } else {
                sinkList.innerHTML = '<div class="list-group-item text-muted text-center no-sinks-placeholder">Ses çıkışı bulunamadı.</div>';
            }
        }

        function updateSystemStatus(statusData) {
            const btSpan = document.getElementById('status-bluetooth-service');
            const paSpan = document.getElementById('status-pulseaudio-service');
            const sinkSpan = document.getElementById('status-default-sink');

            if(btSpan) {
                btSpan.textContent = statusData?.bluetooth_adapter_available ? 'Aktif' : 'Pasif/Hata';
                btSpan.className = `badge badge-${statusData?.bluetooth_adapter_available ? 'success' : 'danger'}`;
            }
             if(paSpan) {
                paSpan.textContent = statusData?.pulseaudio_available ? 'Aktif' : 'Pasif/Hata';
                paSpan.className = `badge badge-${statusData?.pulseaudio_available ? 'success' : 'danger'}`;
            }
            if(sinkSpan && statusData?.sinks) {
                 const defaultSink = statusData.sinks.find(s => s.name === statusData.default_sink_name);
                 sinkSpan.textContent = defaultSink ? defaultSink.description.substring(0, 25) + '...' : (statusData.default_sink_name || 'Bilinmiyor'); // Truncate long names
                 sinkSpan.className = `badge badge-${defaultSink ? 'primary' : 'secondary'}`;
                 sinkSpan.title = defaultSink ? defaultSink.description : (statusData.default_sink_name || 'Bilinmiyor');
             } else if (sinkSpan) {
                 sinkSpan.textContent = 'Bilinmiyor';
                 sinkSpan.className = 'badge badge-secondary';
             }
        }

        // --- Event Listener Attachments ---
        function attachBluetoothButtonListeners() {
            document.querySelectorAll('#paired-devices-list .connect-btn, #discovered-devices-list .connect-btn').forEach(b => b.addEventListener('click', (e) => connectDevice(e.target.closest('.list-group-item').dataset.address, e.target)));
            document.querySelectorAll('#paired-devices-list .disconnect-btn').forEach(b => b.addEventListener('click', (e) => disconnectDevice(e.target.closest('.list-group-item').dataset.address, e.target)));
            document.querySelectorAll('#paired-devices-list .remove-btn').forEach(b => b.addEventListener('click', (e) => {
                const item = e.target.closest('.list-group-item');
                const address = item.dataset.address;
                const name = item.querySelector('.device-name')?.textContent.trim() || address;
                if (confirm(`'${name}' cihazını kaldırmak istediğinizden emin misiniz?`)) removeDevice(address, e.target);
            }));
            document.querySelectorAll('#discovered-devices-list .pair-btn').forEach(b => b.addEventListener('click', (e) => pairDevice(e.target.closest('.list-group-item').dataset.address, e.target)));
        }

        function attachSinkButtonListeners() {
             document.querySelectorAll('#audio-sinks-list .switch-sink-btn').forEach(b => b.addEventListener('click', (e) => switchSink(parseInt(e.target.closest('.list-group-item').dataset.sinkIndex), e.target)));
        }

        // --- API Call Functions ---
        async function fetchInitialData() {
            console.log("Fetching initial data...");
            showStatusMessage("Veriler yükleniyor...", "info", 0); // Persistent loading message

            // Fetch data concurrently
            const [devicesRes, sinksRes, statusRes] = await Promise.all([
                handleApiCall('/bluetooth/devices').catch(e => ({ success: false, devices: [], error: e })),
                handleApiCall('/audio/sinks').catch(e => ({ success: false, sinks: [], error: e })),
                handleApiCall('/status').catch(e => ({ success: false, error: e }))
            ]);

             // Clear persistent loading message
             $('#status-message-area .alert:contains("Veriler yükleniyor...")').alert('close');

            // Update data, ensuring defaults if fetches failed
            currentBluetoothDevices = devicesRes?.devices || [];
            currentAudioSinks = sinksRes?.sinks || [];
            defaultSinkName = sinksRes?.default_sink_name || null;

            // Render lists with potentially empty data
            renderBluetoothLists();
            renderSinkList();

            // Update status indicators
            if (statusRes?.success) {
                updateSystemStatus(statusRes);
            } else {
                 // Update with default/unknown status if status call failed
                 updateSystemStatus({ bluetooth_adapter_available: null, pulseaudio_available: null, sinks: [], default_sink_name: null });
                 showStatusMessage("Sistem durumu alınamadı.", "warning");
            }
             console.log("Initial data fetch complete.");
        }

        async function scanBluetooth(buttonElement) {
            showStatusMessage("Bluetooth cihazları taranıyor (5 sn)...", "info", 6000);
            const response = await handleApiCall('/bluetooth/scan', 'POST', { duration: 5 }, buttonElement);
            if (response?.devices) { // Check if devices array exists
                currentBluetoothDevices = response.devices;
                renderBluetoothLists();
            } else if (response && !response.success) {
                 // Handle API call failure if needed, message already shown by handleApiCall
            } else {
                 // Handle unexpected response structure
                 console.warn("Scan response did not contain devices:", response);
                 currentBluetoothDevices = []; // Reset list on unexpected response
                 renderBluetoothLists();
            }
        }

        async function pairDevice(address, buttonElement) {
             showStatusMessage(`'${address}' ile eşleştirme deneniyor...`, "info", 15000);
             const response = await handleApiCall('/bluetooth/pair', 'POST', { address: address }, buttonElement);
             if (response?.success) setTimeout(fetchInitialData, 2000); // Refresh after a delay
        }
        async function connectDevice(address, buttonElement) {
            const response = await handleApiCall('/bluetooth/connect', 'POST', { address: address }, buttonElement);
            if (response) setTimeout(fetchInitialData, 1500); // Refresh regardless of success/fail after action
        }
        async function disconnectDevice(address, buttonElement) {
            const response = await handleApiCall('/bluetooth/disconnect', 'POST', { address: address }, buttonElement);
             if (response) setTimeout(fetchInitialData, 1500);
        }
        async function removeDevice(address, buttonElement) {
             const response = await handleApiCall('/bluetooth/remove', 'POST', { address: address }, buttonElement);
             if (response?.success) {
                  // Optimistic UI update: remove immediately from local list
                  currentBluetoothDevices = currentBluetoothDevices.filter(d => d.address !== address);
                  renderBluetoothLists();
                  // Optionally still refresh from server after a delay:
                  // setTimeout(fetchInitialData, 1500);
             }
        }
        async function switchSink(sinkIndex, buttonElement) {
             const response = await handleApiCall('/audio/switch_sink', 'POST', { sink_identifier: sinkIndex }, buttonElement);
             if (response?.success) setTimeout(fetchInitialData, 1000); // Refresh sink list
        }
        async function switchToAlsa(buttonElement) {
             const response = await handleApiCall('/audio/switch_alsa', 'POST', {}, buttonElement);
             if (response?.success) setTimeout(fetchInitialData, 1000);
        }
        async function restartSpotifyd(buttonElement) {
             // Message is shown by handleApiCall
             await handleApiCall('/spotifyd/restart', 'POST', {}, buttonElement);
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', function() {
            fetchInitialData(); // Load initial state

            // Attach listeners to static buttons
            document.getElementById('scan-bluetooth-btn')?.addEventListener('click', (e) => scanBluetooth(e.target));
            document.getElementById('refresh-sinks-btn')?.addEventListener('click', fetchInitialData); // Refresh all for now
            document.getElementById('switch-alsa-btn')?.addEventListener('click', (e) => switchToAlsa(e.target));
            document.getElementById('restart-spotifyd-btn')?.addEventListener('click', (e) => restartSpotifyd(e.target));
            document.getElementById('refresh-all-btn')?.addEventListener('click', fetchInitialData);

            // Note: Spotify-related forms (settings, queue, connect device selection)
            // will use standard HTML form submission as the backend API for these
            // actions is not implemented in the current app.py.
        });

    </script>

</body>
</html>
